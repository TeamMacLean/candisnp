<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<title>CandiSNP</title>

</head>
<body>

	<div>
		
		<h1><img src="img/photo.PNG" alt="CandiSNP"width="200" height="200">
		<span>Welcome to CandiSNP</span></h1>
	</div>
	

	<script src="fineuploader/jquery-2.0.1.js"></script>
	<link href="css/bootstrap/css/bootstrap.css" rel="stylesheet" media="screen">
	<link href="css/bootstrap/css/bootstrap-select.css" rel="stylesheet" media="screen">

	<script type="text/javascript" src="css/bootstrap/js/bootstrap-select.js"></script>
	<h4>Select palette</h4>

	<select  id="palette_selection" >
		<option>gradient</option>
		<option>contrast</option>
		<option>diverging</option>
		<option>sequential</option>
	
	</select>
		<script src="fineuploader/jquery.fineuploader-3.6.4.js"></script>
	<script src="fineuploader/jquery.fileDownload.js"></script>
	<link href="fineuploader/fineuploader-3.6.4.css" rel="stylesheet">
	<div id="manual-fine-uploader" ></div>
	
	<div id="triggerUpload" class="btn btn-primary" style="margin-top: 10px;">
		<i class="icon-upload icon-white"></i> Upload now
	</div>
	
	
	
	<script>
	$(document).ready(function() {
		
		//when the upload button is clicked, upload the files
		$('#triggerUpload').click(function() {
			//get the number of stored files waiting to be uploaded
			var storedFiles = $('#manual-fine-uploader').fineUploader('getUploads', { status: qq.status.SUBMITTED }).length
			//we'll presume for now they're all good
			var allGood = true;
			//loop through each file
			for ( var i = 0; i < storedFiles; i = i + 1 ){
				//clear any previous warnings
				$('#processor'+i).empty();
				//get each allele frequency in turn
				var current_allele_freq = $('#manual-fine-uploader').find('input[name="allele_freq'+i+'"]').val();
				//if it's not a valid allele frequency, set allGood to false and show a warning
				if (!$.isNumeric(current_allele_freq) || current_allele_freq > 1)
				{
					allGood = false;
					$('#processor'+i).append('<p style="font-family:arial;color:yellow;background-color:blue;font-size:20px;"> Insert a number between 0 and 1</p>');

				}
			}
			
			//we've finished checking the allele frequencies
			//if they're all good upload all files
			if (allGood == true)
			{
				$('#manual-fine-uploader').fineUploader('uploadStoredFiles');
			}
			else{
				console.log( "invalid allele freqs");
			}
			
			
		});
		
		var manualuploader = $('#manual-fine-uploader').fineUploader({
			request: {
				endpoint: 'cgi/upload.cgi'
			},
			autoUpload: false,
			text: {
			uploadButton: '<i class="icon-plus icon-white"></i> Select Files'
			}
			
		})
		
		//called when the file or Blob has been successfully submitted to the uploader. 
		//each time a file is opened insert a text box next to it for the allele frequency
		//and give it a default value of 0.9
		.on('submitted', function(event, id, name) {
			console.debug('Event: ' + event + ' id: ' + id +' name: ' + name);
			var fileItemContainer = $(this).fineUploader('getItemByFileId', id);
			$(fileItemContainer).append('<input type="text" name="allele_freq'+id+'" value="0.9" >');
			$(fileItemContainer).append('<div id="processor'+id+'"></div>')
		})
		
		//called just before a file or Blob upload begins.
		.on('upload', function(event, id, name) {
			//get the identify the current file container
			var fileItemContainer = $(this).fineUploader('getItemByFileId', id),
			//get the entered allele frequency
			enteredAlleleFreq = $(fileItemContainer).find('input[name="allele_freq'+id+'"]').val();
			var palette_selected = $("#palette_selection option:selected").val();
			//var palette_selected = $("#palette_section option:selected").val();

			$(this).fineUploader('setParams', {allele_freq: enteredAlleleFreq, palette: palette_selected}, id);
			console.debug('enteredAlleleFreq:' + enteredAlleleFreq + " palette: " + palette_selected + " id: " + id);
		})
		
		//called when the file or Blob upload has finished
		//when the initial upload has finished create and show a resubmit and 'save data' button and load the plot
		.on('complete', function(event, id, fileName, responseJSON) {
			
			//create a Resubmit button for each file
			var button = $('<button/>', {
				text: 'Resubmit ', //set text 
				id: id, //set id
				
				//when the resubmit button is pressed, get the new allele frequency
				click: function () {
					var current_allele_freq = $(fileItemContainer).find('input[name="allele_freq'+id+'"]').val();
					var palette_selected = $("#palette_selection option:selected").val();
					//check that it's numeric and less of equal to one
					//if it's not, alert the user
					if (!$.isNumeric(current_allele_freq) || current_allele_freq >1)
					{
						console.debug('Allele freq:' + current_allele_freq );
						alert('Use a number between 0 and 1 for file '+fileName);
					}
					//otherwise, process the file
					else
					{
						//show the 'processing' icon whilst it's working
						$('#processor'+id).append("<img src='fineuploader/processing.gif' >");
						
						//and post the new allele freq, along with the filename (which will already be on the server, so
						//no need to re-upload the file) and run the resubmit.cgi script
						$.ajax({
							type: 'POST',
							url: 'cgi/resubmit.cgi',
							async: true,
							data: {allele_freq: current_allele_freq, file_name : fileName, palette: palette_selected}, 
							dataType: 'json',
							//if everything runs OK and 'success' is returned... 
							success: function(data) {
								//display the new plot
								$('#imageLoc'+id).empty().append('<img src="public/'+data.file+'.svg" />');
								//remove the 'processing' icon
								$('#processor'+id).remove();
							}
						});
					}
				}
			})
			//a button to save the .csv data used to create the svg plot
			var saveDataButton = $('<button/>', {
				text: 'Save Dataset ', //set text 
				id: id, //set id
				
				click: function () {
					//get the name of the svg image currently on view
					var currentFileName = $('#imageLoc'+id).children('img').attr('src');
					//get everything before the file extention
					var basename = currentFileName.substring(0, currentFileName.lastIndexOf('.') );
					//download the equivalent csv file
					$.fileDownload(basename+'.csv', {
					//handle failures
					successCallback: function (url) {
						alert('You just got a file download dialog or ribbon for this URL :' + url);
					},
					failCallback: function (html, url) {
						alert('Your file download just failed for this URL:' + url + '\r\n' +
								'Here was the resulting error HTML: \r\n' + html);
						}
					})
				}
				
			})
			var fileItemContainer = $(this).fineUploader('getItemByFileId', id);
			//add the Resubmit and save data buttons and div for the image 
			$(fileItemContainer).append(button);
			$(fileItemContainer).append(saveDataButton);
			$(fileItemContainer).append('<div id="imageLoc'+id+'"></div>');
			//if everything runs OK
			if (responseJSON.success) {
				//append the image to the div
				$('#imageLoc'+id).append('<img src="public/'+responseJSON.file+'.svg" alt="' + id + '">');
			}
		});
		
	});
	

	</script>

</body>

</html>


