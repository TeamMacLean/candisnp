<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
	
	<script src="libs/fineuploader/jquery-2.0.1.js"></script>
	<script type="text/javascript" src="libs/bootstrap/js/bootstrap.js"></script>
	<script src="libs/fineuploader/jquery.fineuploader-3.6.4.js"></script>
	
	<link rel="stylesheet" type="text/css" href="libs/fineuploader/fineuploader-3.6.4.css" >
	<link rel="stylesheet" type="text/css" href="libs/fineuploader/fineuploader-custom.css" >
	<link rel="stylesheet" type="text/css" href="libs/flatui/bootstrap/css/bootstrap.css">
	<link rel="stylesheet" type="text/css" href="libs/flatui/css/flat-ui.css">

	
<title>CandiSNP</title>
	
</head>
<body>


	<div id="banner" style="max-width: 960px">
	<header class="header-custom"</header>
		 <h1 class="tab" ><span style="color:#34BEDA">Candi</span><span style="color:#FFB416">SNP:</span><span style="color:#34BEDA"> identifying candidate SNPs in genomes</span></h1>
	</div>	
	<hr style="height:3px;width:1000px;border:solid 3px" />

	<div class="div-text">
	<h4><span style="color:#34BEDA">Candi</span><span style="color:#FFB416">SNP</span> analyses and provides per-chromosome plots of SNPs across genomes. It shows the location of the SNPs and uses color-coded palettes to identify if the SNPs are in coding or non-coding regions and if they are synonymous or non-synonymous..</h4>
	</div>
	<hr width=1000>
	
	<div class="div-custom">


		<h3>1. Select your genome <img href="#" class="pop" src="img/info.svg" width="20" height="20" alt="Info" rel="popover" data-content="<h4>These genomes are databases which are used with the snpEff tool which is utilised within candiSNP</h4>" data-original-title="Genome selection"></h3>


	
		<select  id="genome_selection" class="tip" title="Select your genome from which your SNPs originated">
			<option value="athalianaTair10">TAIR10</option>
			<option value="athalianaTair9">TAIR9</option>
			<option value="rice7">Rice genome v7</option>
			<option value="SL2.40">Tomoto genome v2.40</option>
			<option value="gmax1.09v8">Glycine max genome 1.09v8</option>
			<option value="grape">Grape genome</option>
			<option value="maizeZmB73">Maize B73</option>
		</select>
		</div>
		
		<div class="div-custom">
			<h3>2. Select your SNP data <img href="#" class="pop" src="img/info.svg" width="20" height="20" alt="Info" rel="popover"
			data-content="<h4>You may use drag and drop. Example data can be found in the CandiSNP src directory. It must contain a header line with colums for 'Chr', 'Pos', 'Ref', 'Alt', 'Allele_Freq', and 'Extra'.
			Generally, chromosome names should contain only the chromosome number such as '5' and not 'Chr5'.</h4>" data-original-title="CandiSNP SNP Data"></h3>
			<div id="manual-fine-uploader" >
		</div>
		
	</div>
	
	<div class="div-custom">
	<h3>3. Select palette to view SNPs <img href="#" class="pop" src="img/info.svg" width="20" height="20" alt="Info" rel="popover" data-content="<h4>Change the palette to suite your data visualisation preferences</h4>" data-original-title="Palette selection"></h3>
	<select  id="palette_selection" class="tip" title="The colour scheme for representing your data">
		<option>gradient</option>
		<option>contrast</option>
		<option>diverging</option>
		<option>sequential</option>
	</select>
	
	</div>
	<div class="div-custom">
	<h3>4. Upload and analyse <img href="#" class="pop" src="img/info.svg" width="20" height="20" alt="Info" rel="popover" data-content="<h4>Your data will be uploaded to the server and analysed. Any further analysis on your data will not require a fresh upload</h4>" data-original-title="Data analysis"></h3>
	<div id="triggerUpload" class="btn btn-primary" style="margin-top: 10px;">
		<a class="tip" style="color: #ffffff;" title="Your files will be uploaded to the server and analysed">
		<i class="icon-upload icon-white" ></i> Upload now</a>
		
		
	</div>
</div>

	<script>
	$(document).ready(function() {
		
		//when the upload button is clicked, upload the files
		$('#triggerUpload').click(function() {
			//get the number of stored files waiting to be uploaded
			var storedFiles = $('#manual-fine-uploader').fineUploader('getUploads', { status: qq.status.SUBMITTED }).length
			//we'll presume for now they're all good
			var allGood = true;
			//loop through each file
			for ( var i = 0; i < storedFiles; i = i + 1 ){
				//clear any previous warnings
				$('#processor'+i).empty();
				//get each allele frequency in turn
				var current_allele_freq = $('#manual-fine-uploader').find('input[name="allele_freq'+i+'"]').val();
				//if it's not a valid allele frequency, set allGood to false and show a warning
				if (!$.isNumeric(current_allele_freq) || current_allele_freq > 1)
				{
					allGood = false;
					$('#processor'+i).append('<p style="color:white;background-color:red;font-size:20px;"> Insert a number between 0 and 1</p>');

				}
			}
			
			//we've finished checking the allele frequencies
			//if they're all good upload all files
			if (allGood == true)
			{
				$('#manual-fine-uploader').fineUploader('uploadStoredFiles');
			}
			else{
				console.log( "invalid allele freqs");
			}
			
			
		});
		
		var manualuploader = $('#manual-fine-uploader').fineUploader({
			request: {
				endpoint: 'cgi/upload.cgi'
			},
			autoUpload: false,
			
			text: {
			uploadButton: '<i class="icon-plus icon-white"></i> Select Files'
		  }
			
		})
		
		//called when the file or Blob has been successfully submitted to the uploader. 
		//each time a file is opened insert a text box next to it for the allele frequency
		//and give it a default value of 0.9
		.on('submitted', function(event, id, name) {
			console.debug('Event: ' + event + ' id: ' + id +' name: ' + name);
			var fileItemContainer = $(this).fineUploader('getItemByFileId', id);
			$(fileItemContainer).append('Allele frequency: <input class="span1" title="Enter an allele frequency between 0-1" type="text" name="allele_freq'+id+'" value="0.9" >');
			$(fileItemContainer).append('<div id="resubmit'+id+'"></div>')
			$(fileItemContainer).append('<div id="processor'+id+'"></div>')
		})
		
		//called just before a file or Blob upload begins.
		.on('upload', function(event, id, name) {
			//get the identify the current file container
			var fileItemContainer = $(this).fineUploader('getItemByFileId', id),
			//get the entered allele frequency
			enteredAlleleFreq = $(fileItemContainer).find('input[name="allele_freq'+id+'"]').val();
			var palette_selected = $("#palette_selection option:selected").val();
			var genome_selected = $("#genome_selection option:selected").val();

			$(this).fineUploader('setParams', {allele_freq: enteredAlleleFreq, genome: genome_selected, palette: palette_selected}, id);
			console.debug('enteredAlleleFreq:' + enteredAlleleFreq + " genome: " + genome_selected + " palette: " + palette_selected + " id: " + id);
		})
		
		//called when the file or Blob upload has finished
		//when the initial upload has finished create and show a resubmit and 'save data' button and load the plot
		.on('complete', function(event, id, fileName, responseJSON) {
			$('#resubmit'+id).append('<input type="submit" id="resubmitButton'+id+'"value="Resubmit" class="btn btn-primary" title="Re-analyse data with new allele frequency"/>');
			
			//when the resubmit button is pressed, get the new allele frequency
			$('#resubmitButton'+id).click(function() {
				var current_allele_freq = $(fileItemContainer).find('input[name="allele_freq'+id+'"]').val();
				var palette_selected = $("#palette_selection option:selected").val();
				var genome_selected = $("#genome_selection option:selected").val();
				//check that it's numeric and less of equal to one
				//if it's not, alert the user
				if (!$.isNumeric(current_allele_freq) || current_allele_freq >1)
				{
					console.debug('Allele freq:' + current_allele_freq );
					alert('Use a number between 0 and 1 for file '+fileName);
				}
				//otherwise, process the file
				else
				{
					//show the 'processing' icon whilst it's working
					$('#processor'+id).append("<img src='libs/fineuploader/processing.gif' >");
					
					//and post the new allele freq, along with the filename (which will already be on the server, so
					//no need to re-upload the file) and run the resubmit.cgi script
					$.ajax({
						type: 'POST',
						url: 'cgi/resubmit.cgi',
						async: true,
						data: {allele_freq: current_allele_freq, file_name : fileName, genome: genome_selected, palette: palette_selected}, 
						dataType: 'json',
						//if everything runs OK and 'success' is returned... 
						success: function(data) {
							//display the new plot
							$('#imageLoc'+id).empty().append('<img src="public/'+data.file+'.svg" />');
							//remove the 'processing' icon
							$('#processor'+id).empty();
							var baseFileName = fileName.substring(0, fileName.lastIndexOf('.') );
							
							$('#saveData'+id).empty().append('<a href="public/'+data.file+'.csv" download="'+baseFileName+'.csv" class="btn btn-small btn-info" title="Save your data to file">Save data</a>');
							$('#saveData'+id).append('<a href="public/'+data.file+'.svg" download="'+baseFileName+'.svg" margin="10px" class="btn btn-small btn-info" title="Save the plot to file">Save image</a>');

						}
					});
				}
			
			})
			
			console.debug ("current file name "+responseJSON.file);
			
			var fileItemContainer = $(this).fineUploader('getItemByFileId', id);
			//add the Resubmit and save data buttons and div for the image 
			//$('#resubmit'+id).append(resubmitButton);
			//$(fileItemContainer).append(saveDataButton);
			$(fileItemContainer).append('<div id="saveData'+id+'"></div>');
			$(fileItemContainer).append('<div id="imageLoc'+id+'"></div>');
			
			//if everything runs OK
			if (responseJSON.success) {
				var baseFileName = fileName.substring(0, fileName.lastIndexOf('.') );
				//use the html5 'download' attribute to download the svg
				//(which would just be rendered to screen by browser using the filedowload method above)
				$('#saveData'+id).append('<a href="public/'+responseJSON.file+'.csv" download="'+baseFileName+'.csv" class="btn btn-small btn-info" title="Save your data to file">Save data</a>');
				$('#saveData'+id).append('<a href="public/'+responseJSON.file+'.svg" download="'+baseFileName+'.svg" margin="10px" class="btn btn-small btn-info" title="Save the plot to file">Save image</a>');

				//append the image to the div
				$('#imageLoc'+id).append('<img src="public/'+responseJSON.file+'.svg" alt="' + id + '">');
			}
			$(fileItemContainer).append('<hr>');
		});
		
	});
	</script>

<script>
$(function () {
	$(".pop").popover(
	{
		trigger: 'hover',
		html: 'true',
		delay: 500,
		content: '<div style="font-size:14px;">'
	});
});
</script>
<script>
$(function () {
    $('.tip').tooltip()
});
</script>

</body>

</html>


